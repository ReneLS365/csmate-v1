<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>akkordseddel</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="print.css" media="print">
</head>
<body>
<header>
  <div class="bar">
    <div class="ttl">akkordseddel</div>
    <nav>
      <button id="btnSagsinfo" data-section="sagsinfo" class="active" type="button">Sagsinfo</button>
      <button id="btnOptaelling" data-section="optaelling" type="button">Opt√¶lling</button>
      <button id="btnLon" data-section="lon" type="button">L√∏n</button>
    </nav>
  </div>
</header>
<main>
  <section id="sagsinfoSection" class="sektion">
    <fieldset>
      <legend>Stamdata</legend>
      <div class="status-bar">
        <label for="sagStatus" class="status-select">
          <span>Status</span>
          <select id="sagStatus" name="sagStatus">
            <option value="kladde">Kladde</option>
            <option value="afventer">Afventer</option>
            <option value="godkendt">Godkendt</option>
            <option value="afvist">Afvist</option>
          </select>
        </label>
        <div class="status-indicator">
          <span>Aktuel status</span>
          <strong id="statusIndicator" data-status="kladde" class="status-pill">Kladde</strong>
        </div>
      </div>
      <div class="form-grid grid-3">
        <label for="sagsnummer">
          <span>Sagsnummer</span>
          <input id="sagsnummer" name="sagsnummer" type="text" required>
        </label>
        <label for="sagsnavn">
          <span>Navn/opgave</span>
          <input id="sagsnavn" name="navn" type="text" required>
        </label>
        <label for="sagsadresse">
          <span>Adresse</span>
          <input id="sagsadresse" name="adresse" type="text" required>
        </label>
        <label for="sagskunde">
          <span>Kunde</span>
          <input id="sagskunde" name="kunde" type="text" required>
        </label>
        <label for="sagsdato" class="date-field">
          <span>Dato</span>
          <div class="date-input-wrapper">
            <input id="sagsdato" name="dato" type="date" required inputmode="numeric">
            <button id="calendarIcon" class="date-picker-trigger" type="button" aria-label="√Öbn kalender">üìÖ</button>
          </div>
        </label>
        <label for="sagsmontoer" class="col-span-3">
          <span>Mont√∏rnavne</span>
          <textarea id="sagsmontoer" name="montoer" rows="3" placeholder="Fx: Anna Jensen, Bo Nielsen" required></textarea>
        </label>
      </div>
      <div class="form-actions no-print">
        <button id="btnOpenGuideModal" type="button">√Öbn guide</button>
      </div>
    </fieldset>
  </section>

  <section id="optaellingSection" class="sektion" hidden>
    <fieldset>
      <legend>Systemer</legend>
      <div id="listSelectors" class="row"></div>
    </fieldset>

    <fieldset>
      <legend>Materialer</legend>
      <div class="material-options no-print">
        <label class="toggle-selected">
          <input type="checkbox" id="showSelectedOnly" />
          <span>Vis kun valgte materialer</span>
        </label>
      </div>

      <div id="selectedItemsSummary" class="no-print"
           style="display:none;margin:8px 0 16px 0;"></div>

      <div id="optaellingContainer" class="materials"></div>
    </fieldset>

    <section id="overview" class="overview">
      <div class="totals">
        <div>
          <span>Materialesum</span>
          <strong data-total="material">0,00</strong>
        </div>
        <div>
          <span>L√∏nsum</span>
          <strong data-total="labor">0,00</strong>
        </div>
        <div>
          <span>Projektsum</span>
          <strong data-total="project">0,00</strong>
        </div>
      </div>
    </section>

    <section id="importer" class="import-zone no-print">
      <input id="csvFileInput" type="file" accept=".csv,text/csv,.json,application/json" hidden>
      <div id="dropArea" class="drop-area" role="button" tabindex="0" aria-label="Tr√¶k en CSV eller JSON hertil eller klik for at v√¶lge">
        <p><strong>Importer fil</strong></p>
        <p>Tr√¶k og slip din CSV/JSON her, eller klik for at v√¶lge</p>
      </div>
      <div class="recent-cases">
        <label for="recentCases" class="sr-only">Seneste sager</label>
        <select id="recentCases" aria-label="Seneste sager"></select>
        <button type="button" id="btnLoadCase" disabled>Indl√¶s sag</button>
      </div>
    </section>

    <div class="row btn-group no-print">
      <button id="btnExportCSV" type="button" disabled>Del til E‚Äëkomplet (CSV)</button>
      <button id="btnExportAll" type="button" disabled>Eksport√©r PDF + CSV</button>
      <button id="btnExportZip" type="button" disabled>Del til E‚Äëkomplet (ZIP)</button>
    </div>
    <p id="actionHint" class="hint no-print">Udfyld Sagsinfo for at forts√¶tte.</p>

    <fieldset class="no-print">
      <legend>Admin</legend>
      <div class="row">
        <label class="sr-only" for="adminCode">Admin kode</label>
        <input id="adminCode" placeholder="Kode">
        <button type="button" onclick="login()">Log ind</button>
      </div>
      <p id="adminFeedback" class="status-message" hidden aria-live="polite"></p>
    </fieldset>
  </section>

  <section id="lonSection" class="sektion" hidden>
    <fieldset>
      <legend>Type & bel√∏b</legend>
      <div class="grid-3">
        <label for="jobType"><span>Arbejdstype</span>
          <select id="jobType">
            <option value="montage">Montage</option>
            <option value="demontage">Demontage (50%)</option>
          </select>
        </label>
        <label for="montagepris"><span>Montagepris (auto)</span>
          <input id="montagepris" placeholder="Montagepris (auto)" inputmode="decimal">
        </label>
        <label for="demontagepris"><span>Demontagepris (auto)</span>
          <input id="demontagepris" placeholder="Demontagepris (auto)" inputmode="decimal">
        </label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Till√¶g & km</legend>
      <div class="grid-2">
        <label for="slaebePct"><span>Sl√¶b i %</span>
          <input id="slaebePct" placeholder="Sl√¶b i %" inputmode="decimal">
        </label>
        <label for="km"><span>Km</span>
          <input id="km" placeholder="Km" inputmode="decimal">
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Ekstra arbejde</legend>
      <div class="grid-3 extra-work-grid">
        <label for="antalBoringHuller"><span>Huller (antal)</span>
          <input id="antalBoringHuller" placeholder="Huller (antal)" inputmode="numeric">
        </label>
        <label for="antalLukHuller"><span>Luk af hul (antal)</span>
          <input id="antalLukHuller" placeholder="Luk af hul (antal)" inputmode="numeric">
        </label>
        <label for="antalBoringBeton"><span>Boring i beton (antal)</span>
          <input id="antalBoringBeton" placeholder="Boring i beton (antal)" inputmode="numeric">
        </label>
        <label for="traelleloeft35"><span>Trallel√∏ft 0,35 (antal)</span>
          <input id="traelleloeft35" placeholder="Trallel√∏ft 0,35 (antal)" inputmode="numeric">
        </label>
        <label for="traelleloeft50"><span>Trallel√∏ft 0,50 (antal)</span>
          <input id="traelleloeft50" placeholder="Trallel√∏ft 0,50 (antal)" inputmode="numeric">
        </label>
      </div>
    </fieldset>

    <section class="overview overview-inline">
      <div class="totals">
        <div>
          <span>Materialesum</span>
          <strong data-total="material">0,00</strong>
        </div>
        <div>
          <span>L√∏nsum</span>
          <strong data-total="labor">0,00</strong>
        </div>
        <div>
          <span>Projektsum</span>
          <strong data-total="project">0,00</strong>
        </div>
      </div>
    </section>

    <div class="row no-print btn-group">
      <button id="btnBeregnLon" type="button">Beregn l√∏n</button>
      <button id="btnPrint" type="button" disabled>Print</button>
    </div>
    <fieldset>
      <legend>Resultat</legend>
      <div id="lonResult"></div>
    </fieldset>

    <fieldset class="no-print">
      <legend>Medarbejdere</legend>
      <div id="workers"></div>
      <div class="row">
        <button id="btnAddWorker" type="button">+ Tilf√∏j mand</button>
      </div>
    </fieldset>
  </section>
</main>

<div id="guideModal" class="modal" hidden aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="guideModalTitle" tabindex="-1">
    <button type="button" class="modal-close" aria-label="Luk">√ó</button>
    <h2 id="guideModalTitle">Guide til CSMate</h2>
    <p>
      F√∏lg disse trin for at genskabe den stabile arbejdsgang:
    </p>
    <ol>
      <li>Udfyld <strong>Sagsinfo</strong> med de grundl√¶ggende oplysninger.</li>
      <li>V√¶lg system i <strong>Opt√¶lling</strong> og indtast materialer.</li>
      <li>Importer eller eksporter CSV efter behov og gener√©r PDF.</li>
      <li>Tilf√∏j medarbejdere under <strong>L√∏n</strong> og beregn akkord.</li>
    </ol>
    <p>
      Har du brug for yderligere hj√¶lp, kan du kontakte administratoren eller sl√• op i virksomhedens
      interne vejledninger.
    </p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="main.js"></script>
<script>
  (function initMaterialsUI() {
    const materialsContainer = document.getElementById('optaellingContainer');
    if (!materialsContainer) {
      return;
    }

    const qtyFormatter = new Intl.NumberFormat('da-DK', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 2,
    });
    const priceFormatter = new Intl.NumberFormat('da-DK', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
    const currencyFormatter = new Intl.NumberFormat('da-DK', {
      style: 'currency',
      currency: 'DKK',
    });
    const boundRows = new WeakSet();

    function parseQty(value) {
      if (typeof value === 'number') {
        return Number.isFinite(value) ? value : 0;
      }
      if (value == null) {
        return 0;
      }
      const trimmed = String(value).trim();
      if (!trimmed) {
        return 0;
      }
      const compact = trimmed.replace(/\s+/g, '').replace(/'/g, '');
      const separators = compact.match(/[.,]/g) || [];
      let normalized = compact.replace(/[^0-9.,-]/g, '');

      if (separators.length > 1) {
        const lastSeparator = separators[separators.length - 1];
        const decimalIndex = normalized.lastIndexOf(lastSeparator);
        const integerPart = normalized.slice(0, decimalIndex).replace(/[.,]/g, '').replace(/(?!^)-/g, '');
        const fractionalPart = normalized.slice(decimalIndex + 1).replace(/[^0-9]/g, '');
        normalized = `${integerPart || '0'}.${fractionalPart}`;
      } else if (separators.length === 1) {
        if (/^-?\d{1,3}(?:[.,]\d{3})+$/.test(normalized)) {
          normalized = normalized.replace(/[.,]/g, '').replace(/(?!^)-/g, '');
        } else {
          const separator = separators[0];
          const decimalIndex = normalized.lastIndexOf(separator);
          const integerPart = normalized.slice(0, decimalIndex).replace(/[.,]/g, '').replace(/(?!^)-/g, '');
          const fractionalPart = normalized.slice(decimalIndex + 1).replace(/[^0-9]/g, '');
          normalized = `${integerPart || '0'}.${fractionalPart}`;
        }
      } else {
        normalized = normalized.replace(/(?!^)-/g, '');
      }

      const parsed = Number.parseFloat(normalized);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function formatQtyDK(value) {
      const numericValue = Number.isFinite(value) ? value : parseQty(value);
      return Number.isFinite(numericValue) ? qtyFormatter.format(numericValue) : '';
    }

    function round2(value) {
      const numericValue = parseQty(value);
      return Math.round(numericValue * 100) / 100;
    }

    function updateLine(row, options = {}) {
      const { formatPrice = false, shouldUpdateTotals = true } = options;
      if (!row) {
        return;
      }

      const qtyInput = row.querySelector('.mat-qty');
      const priceInput = row.querySelector('.mat-price');
      const lineInput = row.querySelector('.mat-line');

      if (!qtyInput || !priceInput || !lineInput) {
        return;
      }

      const qty = parseQty(qtyInput.value);
      const dataPrice = priceInput.dataset ? priceInput.dataset.price : '';
      const hasDatasetPrice = dataPrice != null && dataPrice !== '';
      const unitPrice = hasDatasetPrice ? parseQty(dataPrice) : parseQty(priceInput.value);

      if (hasDatasetPrice || formatPrice) {
        priceInput.value = priceFormatter.format(unitPrice);
      }

      const lineValue = round2(qty * unitPrice);
      lineInput.value = currencyFormatter.format(lineValue);

      if (shouldUpdateTotals && typeof updateTotals === 'function') {
        updateTotals();
      }
    }

    function handleQtyInput(event) {
      const row = event.currentTarget.closest('.material-row');
      updateLine(row);
    }

    function handleQtyCommit(event) {
      const input = event.currentTarget;
      if (input.value.trim() === '') {
        input.value = '';
      } else {
        const qty = parseQty(input.value);
        input.value = formatQtyDK(qty);
      }
      const row = input.closest('.material-row');
      updateLine(row);
    }

    function handlePriceInput(event) {
      const row = event.currentTarget.closest('.material-row');
      updateLine(row);
    }

    function handlePriceCommit(event) {
      const input = event.currentTarget;
      if (input.value.trim() === '') {
        input.value = '';
      } else {
        const price = parseQty(input.dataset && input.dataset.price ? input.dataset.price : input.value);
        input.value = priceFormatter.format(price);
      }
      const row = input.closest('.material-row');
      updateLine(row, { formatPrice: true });
    }

    function bindRow(row) {
      if (!row || boundRows.has(row)) {
        return;
      }
      boundRows.add(row);

      const qtyInput = row.querySelector('.mat-qty');
      if (qtyInput) {
        qtyInput.addEventListener('input', handleQtyInput);
        qtyInput.addEventListener('change', handleQtyCommit);
        qtyInput.addEventListener('blur', handleQtyCommit);
        if (qtyInput.value.trim() !== '') {
          const qty = parseQty(qtyInput.value);
          qtyInput.value = formatQtyDK(qty);
        }
      }

      const priceInput = row.querySelector('.mat-price');
      if (priceInput) {
        priceInput.addEventListener('input', handlePriceInput);
        priceInput.addEventListener('change', handlePriceCommit);
        priceInput.addEventListener('blur', handlePriceCommit);
      }

      updateLine(row, { formatPrice: true, shouldUpdateTotals: false });
    }

    function bindExistingRows() {
      document.querySelectorAll('.material-row').forEach(row => bindRow(row));
    }

    bindExistingRows();

    const observer = new MutationObserver(mutations => {
      let totalsDirty = false;
      mutations.forEach(mutation => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(node => {
            if (!(node instanceof Element)) {
              return;
            }
            if (node.classList.contains('material-row')) {
              bindRow(node);
              totalsDirty = true;
            } else {
              node.querySelectorAll && node.querySelectorAll('.material-row').forEach(child => {
                bindRow(child);
                totalsDirty = true;
              });
            }
          });
        } else if (mutation.type === 'attributes' && mutation.attributeName === 'data-price') {
          const row = mutation.target.closest('.material-row');
          if (row) {
            updateLine(row, { formatPrice: true, shouldUpdateTotals: false });
            totalsDirty = true;
          }
        }
      });

      if (totalsDirty && typeof updateTotals === 'function') {
        updateTotals();
      }
    });

    observer.observe(materialsContainer, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['data-price'],
    });

    if (typeof updateTotals === 'function') {
      updateTotals();
    }

    window.parseQty = parseQty;
    window.formatQtyDK = formatQtyDK;
    window.round2 = round2;
    window.updateMaterialLine = (row, options = {}) => updateLine(row, options);
  })();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').then(reg => {
      reg.onupdatefound = () => {
        const newWorker = reg.installing;
        if (!newWorker) return;
        newWorker.onstatechange = () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            window.location.reload();
          }
        };
      };
    });
  }
</script>
</body>
</html>
