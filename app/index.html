<!doctype html>
<html lang="da">
<head>
  <!-- keep charset meta within first kilobyte for Lighthouse best-practice -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="CSMate ‚Äì stilladsopt√¶lling, akkord og PWA til byggepladsen.">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>akkordseddel</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="src/ui/numpad.css">
  <link rel="stylesheet" href="print.css" media="print">
  <link rel="stylesheet" href="src/styles/fixes.css">
  <link rel="stylesheet" href="/css/pwa.css">
  <link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="canonical" href="/">
</head>
<body>
  <a class="skip-to-content" href="#main">Spring til indhold</a>
  <div id="statusbar" class="statusbar offline">
    <span class="status-dot offline" id="status-dot"></span>
    <span id="status-text">Offline</span>
    <span class="muted">Sidst synkroniseret: <span id="last-sync">-</span></span>
    <button id="btn-sync-now" class="btn small">Synkronis√©r nu</button>
  </div>
  <div id="iosInstallPrompt" class="ios-install-prompt" role="region" aria-live="polite" hidden>
    <p>Tilf√∏j CSMate til hjemmesk√¶rmen: Tryk p√• delingsknappen og v√¶lg <strong>F√∏j til hjemmesk√¶rm</strong>.</p>
    <button type="button" id="iosInstallDismiss" class="ios-install-dismiss" aria-label="Skjul iOS installationshint">‚úï</button>
  </div>
  <div id="app" class="app-shell">
    <header data-allow-click>
      <div class="bar">
        <h1 class="ttl">akkordseddel</h1>
        <nav>
          <button id="btnJobs" data-section="jobs" class="active" type="button">Job</button>
          <button id="btnSagsinfo" data-section="sagsinfo" type="button">Sagsinfo</button>
          <button id="btnOptaelling" data-section="optaelling" type="button">Opt√¶lling</button>
          <button id="btnLon" data-section="lon" type="button">L√∏n</button>
          <button id="btnHistorik" data-section="historik" type="button">Historik</button>
          <button data-tab="help" data-section="help" id="tab-btn-help" type="button">Hj√¶lp</button>
        </nav>
        <div class="user-controls no-print">
          <span id="currentUserInfo" class="user-label">Ingen bruger</span>
          <button id="btnOpenUserOverlay" type="button">Skift bruger</button>
        </div>
      </div>
    </header>
    <div class="app-content">
      <div class="materials-scroll">
        <main id="main">
  <section id="jobsSection" class="sektion">
    <div class="job-toolbar">
      <div class="job-toolbar-left">
        <label for="jobSearch" class="sr-only">S√∏g job</label>
        <input id="jobSearch" type="search" placeholder="S√∏g efter sagsnummer, navn eller kunde">
        <label for="jobStatusFilter" class="sr-only">Filtrer status</label>
        <select id="jobStatusFilter">
          <option value="alle">Alle statusser</option>
          <option value="montage">Montage</option>
          <option value="i_brug">I brug</option>
          <option value="demontage">Demontage</option>
          <option value="lukket">Lukket</option>
        </select>
        <label class="job-toggle-archived">
          <input type="checkbox" id="toggleArchived">
          <span>Vis arkiverede</span>
        </label>
      </div>
      <div class="job-toolbar-right">
        <button id="btnCreateJob" type="button">Opret nyt job</button>
      </div>
    </div>
    <div class="job-table-wrapper">
      <table class="job-table" aria-describedby="jobTableCaption">
        <caption id="jobTableCaption" class="sr-only">Oversigt over jobs</caption>
        <thead>
          <tr>
            <th scope="col">Sagsnummer</th>
            <th scope="col">Navn</th>
            <th scope="col">Kunde</th>
            <th scope="col">Systemer</th>
            <th scope="col">Status</th>
            <th scope="col">Sidst opdateret</th>
            <th scope="col" class="actions">Handlinger</th>
          </tr>
        </thead>
        <tbody id="jobList"></tbody>
      </table>
    </div>
    <section id="archivedJobs" class="archived-jobs" hidden>
      <h2>Arkiverede jobs</h2>
      <table class="job-table" aria-describedby="archivedCaption">
        <caption id="archivedCaption" class="sr-only">Arkiverede jobs</caption>
        <thead>
          <tr>
            <th scope="col">Sagsnummer</th>
            <th scope="col">Navn</th>
            <th scope="col">Kunde</th>
            <th scope="col">Systemer</th>
            <th scope="col">Status</th>
            <th scope="col">Sidst opdateret</th>
            <th scope="col" class="actions">Handlinger</th>
          </tr>
        </thead>
        <tbody id="archivedJobList"></tbody>
      </table>
    </section>
  </section>

  <section id="sagsinfoSection" class="sektion">
    <fieldset>
      <legend>Stamdata</legend>
      <div class="status-bar">
        <label for="sagStatus" class="status-select">
          <span>Status</span>
          <select id="sagStatus" name="sagStatus">
            <option value="kladde">Kladde</option>
            <option value="afventer">Afventer</option>
            <option value="godkendt">Godkendt</option>
            <option value="afvist">Afvist</option>
          </select>
        </label>
        <div class="status-indicator">
          <span>Aktuel status</span>
          <strong id="statusIndicator" data-status="kladde" class="status-pill">Kladde</strong>
        </div>
        <div class="job-lock-status" aria-live="polite">
          <span id="jobLockBadge" class="status-pill" hidden>Job l√•st</span>
          <span id="jobSentBadge" class="status-pill" hidden>Fremsendt</span>
        </div>
      </div>
      <div class="form-grid grid-3">
        <label for="sagsnummer">
          <span>Sagsnummer</span>
          <input id="sagsnummer" name="sagsnummer" type="text" required>
        </label>
        <label for="sagsnavn">
          <span>Navn/opgave</span>
          <input id="sagsnavn" name="navn" type="text" required>
        </label>
        <label for="sagsadresse">
          <span>Adresse</span>
          <input id="sagsadresse" name="adresse" type="text" required>
        </label>
        <label for="sagskunde">
          <span>Kunde</span>
          <input id="sagskunde" name="kunde" type="text" required>
        </label>
        <label for="sagsdato" class="date-field">
          <span>Dato</span>
          <div class="date-input-wrapper">
            <input id="sagsdato" name="dato" type="date" required inputmode="numeric">
            <button id="calendarIcon" class="date-picker-trigger" type="button" aria-label="√Öbn kalender">üìÖ</button>
          </div>
        </label>
        <label for="sagsmontoer" class="col-span-3">
          <span>Mont√∏rnavne</span>
          <textarea id="sagsmontoer" name="montoer" rows="3" placeholder="Fx: Anna Jensen, Bo Nielsen" required></textarea>
        </label>
      </div>
      <div class="form-actions no-print">
        <button id="btnOpenGuideModal" type="button">√Öbn guide</button>
        <div class="job-action-group">
          <button id="btnLockJob" type="button" disabled>L√•s akkordseddel</button>
          <button id="btnMarkSent" type="button" disabled>Marker som fremsendt</button>
        </div>
      </div>
    </fieldset>
    <section id="job-export" class="card">
      <h3>Eksport</h3>
      <button id="btn-export-all" class="btn primary">Eksport√©r alt for dette job</button>
      <small id="export-help" class="muted">Kr√¶ver udfyldt sagsinfo</small>
    </section>
  </section>

  <section id="optaellingSection" class="sektion" hidden>
    <fieldset>
      <legend>Systemer</legend>
      <div id="systemTabs" class="system-tabs" role="tablist" aria-label="Systemer">
        <button type="button" data-system="BOSTA70" role="tab" aria-selected="true">BOSTA</button>
        <button type="button" data-system="HAKI" role="tab" aria-selected="false">HAKI</button>
        <button type="button" data-system="MODEX" role="tab" aria-selected="false">MODEX</button>
        <button type="button" data-system="ALFIX_VARIO" role="tab" aria-selected="false">Alfix VARIO</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Materialer</legend>
      <div class="material-options no-print">
        <label class="toggle-selected">
          <input type="checkbox" id="showSelectedOnly" />
          <span>Vis kun valgte materialer</span>
        </label>
      </div>

      <div id="optaellingContainer" class="materials"></div>
    </fieldset>

    <section id="overview" class="overview">
      <div class="totals">
        <div>
          <span>Materialesum</span>
          <strong data-total="material">0,00</strong>
        </div>
        <div>
          <span>L√∏nsum</span>
          <strong data-total="labor">0,00</strong>
        </div>
        <div>
          <span>Projektsum</span>
          <strong data-total="project">0,00</strong>
        </div>
      </div>
    </section>

    <section id="importer" class="import-zone no-print">
      <input id="csvFileInput" type="file" accept=".csv,text/csv,.json,application/json" hidden>
      <div id="dropArea" class="drop-area" role="button" tabindex="0" aria-label="Tr√¶k en CSV eller JSON hertil eller klik for at v√¶lge">
        <p><strong>Importer fil</strong></p>
        <p>Tr√¶k og slip din CSV/JSON her, eller klik for at v√¶lge</p>
      </div>
      <div class="recent-cases">
        <label for="recentCases" class="sr-only">Seneste sager</label>
        <select id="recentCases" aria-label="Seneste sager"></select>
        <button type="button" id="btnLoadCase" disabled>Indl√¶s sag</button>
      </div>
    </section>

    <div class="row btn-group no-print">
      <button id="btnExportCSV" type="button" disabled>Del til E‚Äëkomplet (CSV)</button>
      <button id="btnExportAll" type="button" disabled>Eksport√©r PDF + CSV</button>
      <button id="btnExportZip" type="button" disabled>Del til E‚Äëkomplet (ZIP)</button>
    </div>
    <p id="actionHint" class="hint no-print">Udfyld Sagsinfo for at forts√¶tte.</p>

    <fieldset class="no-print" data-allow-click>
      <legend>Admin</legend>
      <div class="row">
        <label class="sr-only" for="adminCode">Admin kode</label>
        <input id="adminCode" placeholder="Kode">
        <button id="btnAdminLogin" type="button">Log ind</button>
      </div>
      <p id="adminFeedback" class="status-message" hidden aria-live="polite"></p>
      <button id="btnHardResetApp" type="button" hidden>Nulstil app-data</button>
      <button id="btn-backup" class="btn" type="button">Eksport√©r al data (ZIP/JSON)</button>
    </fieldset>
  </section>

  <section id="lonSection" class="sektion" hidden>
    <fieldset>
      <legend>Type & bel√∏b</legend>
      <div class="grid-3">
        <label for="jobType"><span>Arbejdstype</span>
          <select id="jobType">
            <option value="montage">Montage</option>
            <option value="demontage">Demontage (50%)</option>
          </select>
        </label>
        <label for="montagepris"><span>Montagepris (auto)</span>
          <input id="montagepris" placeholder="Montagepris (auto)" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="montagepris">
        </label>
        <label for="demontagepris"><span>Demontagepris (auto)</span>
          <input id="demontagepris" placeholder="Demontagepris (auto)" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="demontagepris">
        </label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Till√¶g & km</legend>
      <div class="grid-2">
        <label for="slaebePct"><span>Sl√¶b i %</span>
          <input id="slaebePct" placeholder="Sl√¶b i %" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="slaebePct">
        </label>
        <label for="km"><span>Km</span>
          <input id="km" placeholder="Km" inputmode="decimal" data-numpad="true" data-decimal="comma" data-numpad-field="km">
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Ekstra arbejde</legend>
      <div class="grid-3 extra-work-grid">
        <label for="antalBoringHuller"><span>Huller (antal)</span>
          <input id="antalBoringHuller" placeholder="Huller (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma" data-testid="antal-input-1" data-numpad-field="antalBoringHuller">
        </label>
        <label for="antalLukHuller"><span>Luk af hul (antal)</span>
          <input id="antalLukHuller" placeholder="Luk af hul (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma" data-numpad-field="antalLukHuller">
        </label>
        <label for="antalBoringBeton"><span>Boring i beton (antal)</span>
          <input id="antalBoringBeton" placeholder="Boring i beton (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma" data-numpad-field="antalBoringBeton">
        </label>
        <label for="antalOpskydeligt"><span>Opskydeligt r√¶kv√¶rk (antal)</span>
          <input id="antalOpskydeligt" placeholder="Opskydeligt r√¶kv√¶rk (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma" data-numpad-field="antalOpskydeligt">
        </label>
        <label for="traelleloeft35"><span>Trallel√∏ft 0,35 (antal)</span>
          <input id="traelleloeft35" placeholder="Trallel√∏ft 0,35 (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma" data-numpad-field="traelleloeft35">
        </label>
        <label for="traelleloeft50"><span>Trallel√∏ft 0,50 (antal)</span>
          <input id="traelleloeft50" placeholder="Trallel√∏ft 0,50 (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma" data-numpad-field="traelleloeft50">
        </label>
      </div>
    </fieldset>

    <section class="overview overview-inline">
      <div class="totals">
        <div>
          <span>Materialesum</span>
          <strong data-total="material">0,00</strong>
        </div>
        <div>
          <span>L√∏nsum</span>
          <strong data-total="labor">0,00</strong>
        </div>
        <div>
          <span>Projektsum</span>
          <strong data-total="project">0,00</strong>
        </div>
      </div>
    </section>

    <div class="row no-print btn-group">
      <button id="btnBeregnLon" type="button">Beregn l√∏n</button>
      <button id="btnPrint" type="button" disabled>Print</button>
      <button id="btn-share-sheet" class="btn" type="button">Del denne akkordseddel</button>
    </div>
    <fieldset>
      <legend>Resultat</legend>
      <div id="lonResult"></div>
    </fieldset>

    <fieldset class="no-print">
      <legend>Medarbejdere</legend>
      <div id="workers"></div>
      <div class="row">
        <button id="btnAddWorker" type="button">+ Tilf√∏j mand</button>
      </div>
    </fieldset>
  </section>

  <section id="historikSection" class="sektion" hidden>
    <fieldset>
      <legend>Historik</legend>
      <div class="history-actions">
        <button id="btnExportAudit" type="button" disabled>Eksporter audit-log (CSV)</button>
      </div>
      <div class="history-table-wrapper">
        <table class="history-table">
          <thead>
            <tr>
              <th scope="col">Tidspunkt</th>
              <th scope="col">Scope</th>
              <th scope="col">Bruger</th>
              <th scope="col">Besked</th>
            </tr>
          </thead>
          <tbody id="auditLogBody"></tbody>
        </table>
      </div>
    </fieldset>
  </section>

  <section id="helpSection" class="sektion" hidden>
    <section id="tab-help" class="tab hidden">
      <h2>Hj√¶lp</h2>
      <div class="grid two">
        <div>
          <h3>Kom hurtigt i gang</h3>
          <ol>
            <li>Opret job</li>
            <li>V√¶lg system</li>
            <li>T√¶l materialer</li>
            <li>Udfyld l√∏n</li>
            <li>Eksport√©r akkordseddel</li>
          </ol>
        </div>
        <div>
          <h3>FAQ</h3>
          <details>
            <summary>Zoom p√• mobil</summary>
            <p>Brug to-finger pinch eller ‚ÄúVis desktopsite‚Äù i browsermenu.</p>
          </details>
          <details>
            <summary>Installer som app (Android)</summary>
            <p>Chrome ‚Üí menu ‚Üí ‚ÄúF√∏j til startsk√¶rm‚Äù.</p>
          </details>
          <details>
            <summary>Installer som app (iOS/Safari)</summary>
            <p>Del-ikon ‚Üí ‚ÄúF√∏j til hjemmesk√¶rm‚Äù.</p>
          </details>
          <h3>Genveje</h3>
          <ul>
            <li><kbd>Ctrl</kbd>/<kbd>‚åò</kbd> + <kbd>S</kbd> Gem aktivt job</li>
            <li><kbd>Ctrl</kbd>/<kbd>‚åò</kbd> + <kbd>P</kbd> Eksport/print</li>
            <li><kbd>Enter</kbd> N√¶ste handling</li>
          </ul>
        </div>
      </div>
      <hr/>
      <section id="scafbook">
        <h3>Book of Scaf Knowledge</h3>
        <div class="grid two">
          <div>
            <h4>Formler (kort)</h4>
            <ul>
              <li>Vindlast: brug kursusformel og lokale data.</li>
              <li>S√∏jletryk: input = egenv√¶gt, nyttelast, areal.</li>
              <li>Transport: 15 m inkl., +7 % pr. 10 m til 55 m.</li>
              <li>Sl√¶b: iht. virksomhedens skema.</li>
            </ul>
          </div>
          <div>
            <h4>Regler</h4>
            <ul>
              <li>Transporttill√¶g: hvorn√•r udl√∏ses.</li>
              <li>S√¶rskilt akkord: typiske cases.</li>
            </ul>
            <h4>Links</h4>
            <ul>
              <li>HP3 Provinsen (PDF)</li>
              <li>Overenskomst 2024‚Äì2026 (PDF)</li>
            </ul>
          </div>
        </div>
      </section>
    </section>
  </section>
        </main>
      </div>
    </div>

    <div id="guideModal" class="modal" hidden aria-hidden="true">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="guideModalTitle" tabindex="-1">
        <button type="button" class="modal-close" aria-label="Luk">√ó</button>
        <h2 id="guideModalTitle">Guide til CSMate</h2>
        <p>
          F√∏lg disse trin for at genskabe den stabile arbejdsgang:
        </p>
        <ol>
          <li>Udfyld <strong>Sagsinfo</strong> med de grundl√¶ggende oplysninger.</li>
          <li>V√¶lg system i <strong>Opt√¶lling</strong> og indtast materialer.</li>
          <li>Importer eller eksporter CSV efter behov og gener√©r PDF.</li>
          <li>Tilf√∏j medarbejdere under <strong>L√∏n</strong> og beregn akkord.</li>
        </ol>
        <p>
          Har du brug for yderligere hj√¶lp, kan du kontakte administratoren eller sl√• op i virksomhedens
          interne vejledninger.
        </p>
      </div>
    </div>
  </div>

  <div id="userOverlay" class="user-overlay" hidden aria-hidden="true">
    <div class="user-overlay-backdrop" data-overlay-dismiss></div>
    <div class="user-overlay-dialog" role="dialog" aria-modal="true" aria-labelledby="userOverlayTitle">
      <button type="button" id="btnCloseUserOverlay" class="user-overlay-close" aria-label="Luk">√ó</button>
      <h2 id="userOverlayTitle">Log ind</h2>
      <form id="userForm">
        <label>
          <span>Navn</span>
          <input id="userName" type="text" autocomplete="name" required>
        </label>
        <label>
          <span>Rolle</span>
          <select id="userRole" required>
            <option value="montor">Mont√∏r</option>
            <option value="formand">Formand</option>
            <option value="firma-admin">Firma-admin</option>
            <option value="owner">Owner</option>
          </select>
        </label>
        <label id="adminCodeRow" class="admin-code-row" hidden>
          <span>Adminkode</span>
          <input id="adminCodeInput" type="password" autocomplete="off" placeholder="StilAce">
        </label>
        <p id="userOverlayFeedback" class="status-message" hidden aria-live="polite"></p>
        <div class="user-overlay-actions">
          <button id="btnSaveUser" type="submit">Gem / Log ind</button>
          <button id="btnCancelUser" type="button">Annuller</button>
        </div>
      </form>
    </div>
  </div>

  <div class="csm-np-overlay" id="npOverlay" aria-hidden="true" data-testid="numpad-backdrop" data-allow-click>
    <div class="csm-np" role="dialog" aria-modal="true" aria-label="Tal-tastatur" tabindex="-1" data-testid="numpad-dialog">
      <div class="csm-np-topbar">
        <button type="button" class="csm-np-close" data-key="close" aria-label="Luk tastatur" data-testid="numpad-close">√ó</button>
        <div class="csm-np-screen" id="npScreen" aria-live="polite">0</div>
      </div>
      <div class="csm-np-grid">
        <button type="button" data-key="7" aria-label="7">7</button>
        <button type="button" data-key="8" aria-label="8">8</button>
        <button type="button" data-key="9" aria-label="9">9</button>
        <button type="button" data-key="√ó" aria-label="gange" class="csm-np-operator">√ó</button>
        <button type="button" data-key="4" aria-label="4">4</button>
        <button type="button" data-key="5" aria-label="5">5</button>
        <button type="button" data-key="6" aria-label="6">6</button>
        <button type="button" data-key="√∑" aria-label="divider" class="csm-np-operator">√∑</button>
        <button type="button" data-key="1" aria-label="1">1</button>
        <button type="button" data-key="2" aria-label="2">2</button>
        <button type="button" data-key="3" aria-label="3">3</button>
        <button type="button" data-key="-" aria-label="minus" class="csm-np-operator">-</button>
        <button type="button" data-key="0" aria-label="0">0</button>
        <button type="button" data-key="," aria-label="komma">,</button>
        <button type="button" data-key="C" aria-label="clear" class="csm-np-operator">C</button>
        <button type="button" data-key="+" aria-label="plus" class="csm-np-operator">+</button>
      </div>
      <button type="button" class="csm-np-equals" data-key="=" aria-label="equals">=</button>
      <button type="button" class="csm-np-enter" data-key="enter">Enter</button>
    </div>
  </div>

<script type="module" src="main.js"></script>
<script>
  // ===== Materials UI init (decimal-safe, da-DK) =====
  (function initMaterialsUI(){
    const container = document.getElementById('optaellingContainer');
    if (!container) return;

    const fmtDK = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK' });

    container.querySelectorAll('.mat-row').forEach(updateLine);

    container.addEventListener('input', (e) => {
      if (!e.target.classList.contains('mat-qty')) return;
      const row = e.target.closest('.mat-row');
      updateLine(row);

      if (typeof recalcTotals === 'function') {
        recalcTotals();
      } else if (typeof updateTotals === 'function') {
        updateTotals();
      }
    });

    const observer = new MutationObserver(mutations => {
      let needsUpdate = false;
      mutations.forEach(mutation => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(node => {
            if (node instanceof Element && (node.classList.contains('mat-row') || node.querySelector('.mat-row'))) {
              needsUpdate = true;
            }
          });
        } else if (mutation.type === 'attributes' && mutation.attributeName === 'data-price') {
          needsUpdate = true;
        }
      });
      if (needsUpdate) {
        container.querySelectorAll('.mat-row').forEach(updateLine);
      }
    });

    observer.observe(container, { childList: true, subtree: true, attributes: true, attributeFilter: ['data-price'] });

    // ===== helpers =====

    function parseQty(value){
      if (value == null) return 0;

      let s = String(value).trim();

      s = s.replace(/\s+/g, '');

      const lastComma = s.lastIndexOf(',');
      const lastDot   = s.lastIndexOf('.');

      if (lastComma > -1 && lastDot > -1){
        if (lastComma > lastDot){
          // decimal = ',', fjern alle '.' (tusind)
          s = s.replace(/\./g, '').replace(',', '.');
        } else {
          // decimal = '.', fjern alle ',' (tusind)
          s = s.replace(/,/g, '');
        }
      } else {
        // Kun √©n type eller ingen: g√∏r ',' til '.'
        s = s.replace(',', '.');
      }

      // Drop alt der ikke er tal eller et enkelt '.' (behold f√∏rste '.' )
      s = s.replace(/[^0-9.]/g, '');
      const firstDot = s.indexOf('.');
      if (firstDot !== -1){
        // fjern √∏vrige '.' efter f√∏rste
        s = s.slice(0, firstDot + 1) + s.slice(firstDot + 1).replace(/\./g, '');
      }

      // Tom/kun '.' => 0
      if (s === '' || s === '.') return 0;

      const n = parseFloat(s);
      if (!Number.isFinite(n) || n < 0) return 0;

      return n;
    }

    // Vis Antal i dansk stil (komma) med ‚Äúp√¶n‚Äù trimming af nuller (fx 7,10 -> 7,1)
    function formatQtyDK(n){
      // behold op til 6 decimaler i visning (kan justeres)
      const str = n.toFixed(6).replace(/0+$/,'').replace(/\.$/,''); // trim trailing zeros
      // skift til dansk komma
      return str.replace('.', ',');
    }

    // Penge: rund til 2 decimaler korrekt (undg√•r FP-st√∏j)
    function round2(n){ return Math.round(n * 100) / 100; }

    function updateLine(row){
      if (!row) return;

      const qtyEl   = row.querySelector('.mat-qty');
      const priceEl = row.querySelector('.mat-price');
      const lineEl  = row.querySelector('.mat-line');
      if (!qtyEl || !priceEl || !lineEl) return;

      const qty   = parseQty(qtyEl.value);
      let price   = parseFloat(priceEl.dataset.price || '');
      if (!Number.isFinite(price)) {
        price = parseQty(priceEl.value);
      }
      const line  = round2(qty * (Number.isFinite(price) ? price : 0));

      const qtyFormatted = formatQtyDK(qty);
      qtyEl.value = qtyEl.type === 'number'
        ? qtyFormatted.replace(',', '.')
        : qtyFormatted;

      const hasQty = qty > 0;
      row.toggleAttribute('data-has-qty', hasQty);
      row.dataset.hasQty = hasQty ? 'true' : 'false';

      if (Number.isFinite(price)) {
        const priceFormatted = price.toFixed(2);
        priceEl.value = priceEl.type === 'number'
          ? priceFormatted
          : priceFormatted.replace('.', ',');
      } else if (priceEl.value) {
        if (priceEl.type === 'number') {
          const fallbackPrice = parseQty(priceEl.value);
          priceEl.value = Number.isFinite(fallbackPrice) ? String(fallbackPrice) : '';
        } else {
          priceEl.value = String(priceEl.value).replace('.', ',');
        }
      } else {
        priceEl.value = '';
      }

      const formattedLine = fmtDK.format(line);
      const lineText = `${formattedLine} kr`;
      if (lineEl instanceof HTMLInputElement) {
        lineEl.value = lineText;
      } else {
        lineEl.textContent = lineText;
      }
    }

    window.parseQty = parseQty;
    window.formatQtyDK = formatQtyDK;
    window.round2 = round2;
    window.updateMaterialLine = row => updateLine(row);
  })();
</script>

  <div class="pwa-install-wrap" role="presentation">
    <button id="installBtn" class="pwa-install-btn" type="button" hidden>Installer app</button>
  </div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('/service-worker.js', { scope: '/' })
        .catch(async error => {
          const offline = navigator.onLine === false;
          const networkErrorNames = new Set(['AbortError', 'NetworkError']);
          const message = typeof error?.message === 'string' ? error.message : '';
          const isNetworkFailure =
            offline ||
            (typeof error === 'object' && error !== null && networkErrorNames.has(error.name)) ||
            /(?:offline|network)/i.test(message);

          if (isNetworkFailure) {
            console.warn('Service worker registration failed due to network issues; keeping existing worker', error);
            return;
          }

          try {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          } finally {
            const url = new URL(window.location.href);
            url.searchParams.set('no-sw', Date.now().toString());
            window.location.replace(url.toString());
          }
        });
    });
  }
</script>
</body>
</html>
