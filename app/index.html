<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>akkordseddel</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="src/ui/numpad.css">
  <link rel="stylesheet" href="print.css" media="print">
</head>
<body>
  <div id="app" class="app-shell">
    <header>
      <div class="bar">
    <div class="ttl">akkordseddel</div>
    <nav>
      <button id="btnSagsinfo" data-section="sagsinfo" class="active" type="button">Sagsinfo</button>
      <button id="btnOptaelling" data-section="optaelling" type="button">Opt√¶lling</button>
      <button id="btnLon" data-section="lon" type="button">L√∏n</button>
    </nav>
      </div>
    </header>
    <div class="app-content">
      <div class="materials-scroll">
        <main>
  <section id="sagsinfoSection" class="sektion">
    <fieldset>
      <legend>Stamdata</legend>
      <div class="status-bar">
        <label for="sagStatus" class="status-select">
          <span>Status</span>
          <select id="sagStatus" name="sagStatus">
            <option value="kladde">Kladde</option>
            <option value="afventer">Afventer</option>
            <option value="godkendt">Godkendt</option>
            <option value="afvist">Afvist</option>
          </select>
        </label>
        <div class="status-indicator">
          <span>Aktuel status</span>
          <strong id="statusIndicator" data-status="kladde" class="status-pill">Kladde</strong>
        </div>
      </div>
      <div class="form-grid grid-3">
        <label for="sagsnummer">
          <span>Sagsnummer</span>
          <input id="sagsnummer" name="sagsnummer" type="text" required>
        </label>
        <label for="sagsnavn">
          <span>Navn/opgave</span>
          <input id="sagsnavn" name="navn" type="text" required>
        </label>
        <label for="sagsadresse">
          <span>Adresse</span>
          <input id="sagsadresse" name="adresse" type="text" required>
        </label>
        <label for="sagskunde">
          <span>Kunde</span>
          <input id="sagskunde" name="kunde" type="text" required>
        </label>
        <label for="sagsdato" class="date-field">
          <span>Dato</span>
          <div class="date-input-wrapper">
            <input id="sagsdato" name="dato" type="date" required inputmode="numeric">
            <button id="calendarIcon" class="date-picker-trigger" type="button" aria-label="√Öbn kalender">üìÖ</button>
          </div>
        </label>
        <label for="sagsmontoer" class="col-span-3">
          <span>Mont√∏rnavne</span>
          <textarea id="sagsmontoer" name="montoer" rows="3" placeholder="Fx: Anna Jensen, Bo Nielsen" required></textarea>
        </label>
      </div>
      <div class="form-actions no-print">
        <button id="btnOpenGuideModal" type="button">√Öbn guide</button>
      </div>
    </fieldset>
  </section>

  <section id="optaellingSection" class="sektion" hidden>
    <fieldset>
      <legend>Systemer</legend>
      <div id="listSelectors" class="row"></div>
    </fieldset>

    <fieldset>
      <legend>Materialer</legend>
      <div class="material-options no-print">
        <label class="toggle-selected">
          <input type="checkbox" id="showSelectedOnly" />
          <span>Vis kun valgte materialer</span>
        </label>
      </div>

      <div id="optaellingContainer" class="materials"></div>
    </fieldset>

    <section id="overview" class="overview">
      <div class="totals">
        <div>
          <span>Materialesum</span>
          <strong data-total="material">0,00</strong>
        </div>
        <div>
          <span>L√∏nsum</span>
          <strong data-total="labor">0,00</strong>
        </div>
        <div>
          <span>Projektsum</span>
          <strong data-total="project">0,00</strong>
        </div>
      </div>
    </section>

    <section id="importer" class="import-zone no-print">
      <input id="csvFileInput" type="file" accept=".csv,text/csv,.json,application/json" hidden>
      <div id="dropArea" class="drop-area" role="button" tabindex="0" aria-label="Tr√¶k en CSV eller JSON hertil eller klik for at v√¶lge">
        <p><strong>Importer fil</strong></p>
        <p>Tr√¶k og slip din CSV/JSON her, eller klik for at v√¶lge</p>
      </div>
      <div class="recent-cases">
        <label for="recentCases" class="sr-only">Seneste sager</label>
        <select id="recentCases" aria-label="Seneste sager"></select>
        <button type="button" id="btnLoadCase" disabled>Indl√¶s sag</button>
      </div>
    </section>

    <div class="row btn-group no-print">
      <button id="btnExportCSV" type="button" disabled>Del til E‚Äëkomplet (CSV)</button>
      <button id="btnExportAll" type="button" disabled>Eksport√©r PDF + CSV</button>
      <button id="btnExportZip" type="button" disabled>Del til E‚Äëkomplet (ZIP)</button>
    </div>
    <p id="actionHint" class="hint no-print">Udfyld Sagsinfo for at forts√¶tte.</p>

    <fieldset class="no-print">
      <legend>Admin</legend>
      <div class="row">
        <label class="sr-only" for="adminCode">Admin kode</label>
        <input id="adminCode" placeholder="Kode">
        <button id="btnAdminLogin" type="button">Log ind</button>
      </div>
      <p id="adminFeedback" class="status-message" hidden aria-live="polite"></p>
      <button id="btnHardResetApp" type="button" hidden>Nulstil app-data</button>
    </fieldset>
  </section>

  <section id="lonSection" class="sektion" hidden>
    <fieldset>
      <legend>Type & bel√∏b</legend>
      <div class="grid-3">
        <label for="jobType"><span>Arbejdstype</span>
          <select id="jobType">
            <option value="montage">Montage</option>
            <option value="demontage">Demontage (50%)</option>
          </select>
        </label>
        <label for="montagepris"><span>Montagepris (auto)</span>
          <input id="montagepris" placeholder="Montagepris (auto)" inputmode="decimal" data-numpad="true" data-decimal="comma">
        </label>
        <label for="demontagepris"><span>Demontagepris (auto)</span>
          <input id="demontagepris" placeholder="Demontagepris (auto)" inputmode="decimal" data-numpad="true" data-decimal="comma">
        </label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Till√¶g & km</legend>
      <div class="grid-2">
        <label for="slaebePct"><span>Sl√¶b i %</span>
          <input id="slaebePct" placeholder="Sl√¶b i %" inputmode="decimal" data-numpad="true" data-decimal="comma">
        </label>
        <label for="km"><span>Km</span>
          <input id="km" placeholder="Km" inputmode="decimal" data-numpad="true" data-decimal="comma">
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Ekstra arbejde</legend>
      <div class="grid-3 extra-work-grid">
        <label for="antalBoringHuller"><span>Huller (antal)</span>
          <input id="antalBoringHuller" placeholder="Huller (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma">
        </label>
        <label for="antalLukHuller"><span>Luk af hul (antal)</span>
          <input id="antalLukHuller" placeholder="Luk af hul (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma">
        </label>
        <label for="antalBoringBeton"><span>Boring i beton (antal)</span>
          <input id="antalBoringBeton" placeholder="Boring i beton (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma">
        </label>
        <label for="antalOpskydeligt"><span>Opskydeligt r√¶kv√¶rk (antal)</span>
          <input id="antalOpskydeligt" placeholder="Opskydeligt r√¶kv√¶rk (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma">
        </label>
        <label for="traelleloeft35"><span>Trallel√∏ft 0,35 (antal)</span>
          <input id="traelleloeft35" placeholder="Trallel√∏ft 0,35 (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma">
        </label>
        <label for="traelleloeft50"><span>Trallel√∏ft 0,50 (antal)</span>
          <input id="traelleloeft50" placeholder="Trallel√∏ft 0,50 (antal)" inputmode="numeric" data-numpad="true" data-decimal="comma">
        </label>
      </div>
    </fieldset>

    <section class="overview overview-inline">
      <div class="totals">
        <div>
          <span>Materialesum</span>
          <strong data-total="material">0,00</strong>
        </div>
        <div>
          <span>L√∏nsum</span>
          <strong data-total="labor">0,00</strong>
        </div>
        <div>
          <span>Projektsum</span>
          <strong data-total="project">0,00</strong>
        </div>
      </div>
    </section>

    <div class="row no-print btn-group">
      <button id="btnBeregnLon" type="button">Beregn l√∏n</button>
      <button id="btnPrint" type="button" disabled>Print</button>
    </div>
    <fieldset>
      <legend>Resultat</legend>
      <div id="lonResult"></div>
    </fieldset>

    <fieldset class="no-print">
      <legend>Medarbejdere</legend>
      <div id="workers"></div>
      <div class="row">
        <button id="btnAddWorker" type="button">+ Tilf√∏j mand</button>
      </div>
    </fieldset>
  </section>
        </main>
      </div>
    </div>

    <div id="guideModal" class="modal" hidden aria-hidden="true">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="guideModalTitle" tabindex="-1">
        <button type="button" class="modal-close" aria-label="Luk">√ó</button>
        <h2 id="guideModalTitle">Guide til CSMate</h2>
        <p>
          F√∏lg disse trin for at genskabe den stabile arbejdsgang:
        </p>
        <ol>
          <li>Udfyld <strong>Sagsinfo</strong> med de grundl√¶ggende oplysninger.</li>
          <li>V√¶lg system i <strong>Opt√¶lling</strong> og indtast materialer.</li>
          <li>Importer eller eksporter CSV efter behov og gener√©r PDF.</li>
          <li>Tilf√∏j medarbejdere under <strong>L√∏n</strong> og beregn akkord.</li>
        </ol>
        <p>
          Har du brug for yderligere hj√¶lp, kan du kontakte administratoren eller sl√• op i virksomhedens
          interne vejledninger.
        </p>
      </div>
    </div>
  </div>

  <div class="csm-np-overlay" aria-hidden="true">
  <div class="csm-np" role="dialog" aria-modal="true" aria-label="Numerisk tastatur">
    <div class="csm-np-display" id="csm-np-display" aria-live="polite">0</div>
    <div class="csm-np-grid">
      <button class="csm-np-btn">7</button>
      <button class="csm-np-btn">8</button>
      <button class="csm-np-btn">9</button>
      <button class="csm-np-btn csm-np-op">√ó</button>
      <button class="csm-np-btn">4</button>
      <button class="csm-np-btn">5</button>
      <button class="csm-np-btn">6</button>
      <button class="csm-np-btn csm-np-op">√∑</button>
      <button class="csm-np-btn">1</button>
      <button class="csm-np-btn">2</button>
      <button class="csm-np-btn">3</button>
      <button class="csm-np-btn csm-np-op">-</button>
      <button class="csm-np-btn">0</button>
      <button class="csm-np-btn">,</button>
      <button class="csm-np-btn" data-action="clear">C</button>
      <button class="csm-np-btn csm-np-op">+</button>
    </div>
    <div class="csm-np-footer">
      <button type="button" class="csm-np-confirm" data-action="confirm">Enter</button>
      <button type="button" class="csm-np-cancel np-close" data-action="cancel" aria-label="Luk">√ó</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script type="module" src="main.js"></script>
<script>
  // ===== Materials UI init (decimal-safe, da-DK) =====
  (function initMaterialsUI(){
    const container = document.getElementById('optaellingContainer');
    if (!container) return;

    const fmtDK = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK' });

    container.querySelectorAll('.mat-row').forEach(updateLine);

    container.addEventListener('input', (e) => {
      if (!e.target.classList.contains('mat-qty')) return;
      const row = e.target.closest('.mat-row');
      updateLine(row);

      if (typeof recalcTotals === 'function') {
        recalcTotals();
      } else if (typeof updateTotals === 'function') {
        updateTotals();
      }
    });

    const observer = new MutationObserver(mutations => {
      let needsUpdate = false;
      mutations.forEach(mutation => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(node => {
            if (node instanceof Element && (node.classList.contains('mat-row') || node.querySelector('.mat-row'))) {
              needsUpdate = true;
            }
          });
        } else if (mutation.type === 'attributes' && mutation.attributeName === 'data-price') {
          needsUpdate = true;
        }
      });
      if (needsUpdate) {
        container.querySelectorAll('.mat-row').forEach(updateLine);
      }
    });

    observer.observe(container, { childList: true, subtree: true, attributes: true, attributeFilter: ['data-price'] });

    // ===== helpers =====

    function parseQty(value){
      if (value == null) return 0;

      let s = String(value).trim();

      s = s.replace(/\s+/g, '');

      const lastComma = s.lastIndexOf(',');
      const lastDot   = s.lastIndexOf('.');

      if (lastComma > -1 && lastDot > -1){
        if (lastComma > lastDot){
          // decimal = ',', fjern alle '.' (tusind)
          s = s.replace(/\./g, '').replace(',', '.');
        } else {
          // decimal = '.', fjern alle ',' (tusind)
          s = s.replace(/,/g, '');
        }
      } else {
        // Kun √©n type eller ingen: g√∏r ',' til '.'
        s = s.replace(',', '.');
      }

      // Drop alt der ikke er tal eller et enkelt '.' (behold f√∏rste '.' )
      s = s.replace(/[^0-9.]/g, '');
      const firstDot = s.indexOf('.');
      if (firstDot !== -1){
        // fjern √∏vrige '.' efter f√∏rste
        s = s.slice(0, firstDot + 1) + s.slice(firstDot + 1).replace(/\./g, '');
      }

      // Tom/kun '.' => 0
      if (s === '' || s === '.') return 0;

      const n = parseFloat(s);
      if (!Number.isFinite(n) || n < 0) return 0;

      return n;
    }

    // Vis Antal i dansk stil (komma) med ‚Äúp√¶n‚Äù trimming af nuller (fx 7,10 -> 7,1)
    function formatQtyDK(n){
      // behold op til 6 decimaler i visning (kan justeres)
      const str = n.toFixed(6).replace(/0+$/,'').replace(/\.$/,''); // trim trailing zeros
      // skift til dansk komma
      return str.replace('.', ',');
    }

    // Penge: rund til 2 decimaler korrekt (undg√•r FP-st√∏j)
    function round2(n){ return Math.round(n * 100) / 100; }

    function updateLine(row){
      if (!row) return;

      const qtyEl   = row.querySelector('.mat-qty');
      const priceEl = row.querySelector('.mat-price');
      const lineEl  = row.querySelector('.mat-line');
      if (!qtyEl || !priceEl || !lineEl) return;

      const qty   = parseQty(qtyEl.value);
      let price   = parseFloat(priceEl.dataset.price || '');
      if (!Number.isFinite(price)) {
        price = parseQty(priceEl.value);
      }
      const line  = round2(qty * (Number.isFinite(price) ? price : 0));

      const qtyFormatted = formatQtyDK(qty);
      qtyEl.value = qtyEl.type === 'number'
        ? qtyFormatted.replace(',', '.')
        : qtyFormatted;

      const mirror = row.querySelector('.mat-qty-display');
      if (mirror) {
        const displayValue = qtyEl.value && qtyEl.value.trim().length ? qtyEl.value.trim() : '0';
        mirror.textContent = displayValue;
      }

      const hasQty = qty > 0;
      row.toggleAttribute('data-has-qty', hasQty);
      row.dataset.hasQty = hasQty ? 'true' : 'false';

      if (Number.isFinite(price)) {
        const priceFormatted = price.toFixed(2);
        priceEl.value = priceEl.type === 'number'
          ? priceFormatted
          : priceFormatted.replace('.', ',');
      } else if (priceEl.value) {
        if (priceEl.type === 'number') {
          const fallbackPrice = parseQty(priceEl.value);
          priceEl.value = Number.isFinite(fallbackPrice) ? String(fallbackPrice) : '';
        } else {
          priceEl.value = String(priceEl.value).replace('.', ',');
        }
      } else {
        priceEl.value = '';
      }

      lineEl.value  = fmtDK.format(line);
    }

    window.parseQty = parseQty;
    window.formatQtyDK = formatQtyDK;
    window.round2 = round2;
    window.updateMaterialLine = row => updateLine(row);
  })();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').catch(async error => {
      const offline = navigator.onLine === false;
      const networkErrorNames = new Set(['AbortError', 'NetworkError']);
      const message = typeof error?.message === 'string' ? error.message : '';
      const isNetworkFailure =
        offline ||
        (typeof error === 'object' && error !== null && networkErrorNames.has(error.name)) ||
        /(?:offline|network)/i.test(message);

      if (isNetworkFailure) {
        console.warn('Service worker registration failed due to network issues; keeping existing worker', error);
        return;
      }

      try {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      } finally {
        const url = new URL(window.location.href);
        url.searchParams.set('no-sw', Date.now().toString());
        window.location.replace(url.toString());
      }
    });
  }
</script>
</body>
</html>
